rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    // User is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // User matches the requested document ID
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if the user is an Admin
    // We check the 'isAdmin' field on the user's profile document.
    // WARNING: Initial bootstrapping requires manual console edit or a temporary rule.
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ==================== USERS COLLECTION ====================

    match /users/{userId} {
      // Public Read: Allows Search, Leaderboards, and Admin lists
      allow read: if isAuthenticated();
      
      // Write:
      // 1. Owner can update their profile (bio, theme, etc.)
      // 2. Admin can update ANY profile (for Ban/Promote actions)
      // 3. Prevent Owner from modifying their own 'isAdmin' or 'isBanned' flags
      allow update: if (isOwner(userId) && 
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'isBanned'])) 
                    || isAdmin();

      // Create: Allow new users to be created by themselves
      allow create: if isOwner(userId);
      
      // --- Subcollection: Data (Library & Gamification) ---
      match /data/{document=**} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId) || isAdmin();
      }

      // --- Subcollection: Friends ---
      match /friends/{friendId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isAuthenticated() && request.auth.uid == friendId;
      }
    }

    // ==================== FEATURES ====================

    // FEEDBACK
    match /feedback/{feedbackId} {
      // Anyone can create feedback
      allow create: if true;
      // Only Admins can read (Dashboard) or update/delete (Resolution)
      allow read, update, delete: if isAdmin();
    }

    // WATCH PARTIES
    match /watchparties/{partyId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // ACTIVITY FEED
    match /activities/{activityId} {
      allow create: if isAuthenticated(); 
      allow read: if isAuthenticated();
    }

    // COMMENTS
    match /comments/{commentId} {
      allow create: if isAuthenticated();
      allow read: if true;
    }

    // CHALLENGES
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== LEGACY / ROOT ACCESS ====================
    // Backup for root collections if used

    match /libraries/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }

    match /gamification/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId) || isAdmin();
    }
  }
}
