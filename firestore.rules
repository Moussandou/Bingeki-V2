rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    // User is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // User matches the requested document ID
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if the user is an Admin
    function isAdmin() {
      // Security: Relies solely on database role. Ensure your user doc has isAdmin: true.
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // ==================== USERS COLLECTION ====================

    match /users/{userId} {
      // Public Read: Allows Search, Leaderboards, and Admin lists
      allow read: if isAuthenticated();
      
      // Write:
      // 1. Owner can update their profile (bio, theme, etc.)
      // 2. Admin can update ANY profile (for Ban/Promote actions)
      // 3. Prevent Owner from modifying their own 'isAdmin' or 'isBanned' flags
      allow update: if (isOwner(userId) && 
                        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'isBanned'])) 
                    || isAdmin();

      // Create & Delete: Allow new users to be created by themselves, and deleted by owner/admin
      allow create: if isOwner(userId);
      allow delete: if isOwner(userId) || isAdmin();
      
      // --- Subcollection: Data (Library & Gamification) ---
      
      // 1. Gamification Data - STRICT SECURITY
      match /data/gamification {
        allow read: if isAuthenticated();
        // Admins can do anything
        allow write: if isAdmin();
        
        // Owner Update: Must validate stats don't jump unreasonably
        allow update: if isOwner(userId) && 
                      // Level check: Max +1 increase
                      request.resource.data.level <= resource.data.level + 1 &&
                      // XP check: Max +1000 increase (generous buffer)
                      request.resource.data.xp <= resource.data.xp + 1000 &&
                      // Streak check: Max +1 increase
                      (request.resource.data.streak <= resource.data.streak + 1 || request.resource.data.streak == 1);
        
        // Owner Create: Must start reasonable
        allow create: if isOwner(userId) && 
                      request.resource.data.level == 1 &&
                      request.resource.data.xp <= 500;
      }

      // 2. Library Data - Standard Access
      match /data/library {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId) || isAdmin();
      }

      // 3. Other Data - Closed by default for security
      // If you add more documents to /data/, add them explicitly above.

      // --- Subcollection: Friends ---
      match /friends/{friendId} {
        allow read, write: if isOwner(userId);
        allow create, update: if isAuthenticated() && request.auth.uid == friendId;
      }
      
      // --- Subcollection: Notifications ---
      match /notifications/{notificationId} {
        allow read, write: if isOwner(userId);
      }

    }

    // ==================== FEATURES ====================

    // FEEDBACK
    match /feedback/{feedbackId} {
      // Anyone can create feedback
      allow create: if isAuthenticated();
      // Users can read their own feedback, Admins can read all
      allow read: if (isAuthenticated() && resource.data.userId == request.auth.uid) || isAdmin();
      // Only Admins can update/delete (Resolution)
      allow update, delete: if isAdmin();
    }

    // WATCH PARTIES
    match /watchparties/{partyId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated();
    }

    // ACTIVITY FEED
    match /activities/{activityId} {
      // Security: Only allow creating activities for YOURSELF
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated();
    }

    // COMMENTS
    match /comments/{commentId} {
      allow create: if isAuthenticated();
      allow read: if true;
    }

    // CHALLENGES
    match /challenges/{challengeId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== GLOBAL CONFIGURATION ====================
    
    // GLOBAL CONFIG (for announcements, maintenance mode, etc.)
    match /config/{configId} {
      // Allow authenticated users to read global config (e.g., announcements)
      allow read: if isAuthenticated();
      // Only admins can update global config
      allow write: if isAdmin();
    }

    // TIER LISTS (NEW)
    match /tierLists/{tierListId} {
      // Public lists can be read by anyone (or just auth users, depending on requirement)
      // Query requiring isPublic==true must match this rule if we use resource.data check
      allow read: if true; // We filter by isPublic in query, but open read allows fetching specific public lists
      
      // Create: Authenticated users can create
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Update/Delete: Only author can modify
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // ==================== LEGACY / ROOT ACCESS ====================
    // DELETED: Legacy root collections removed for security.
    // All data must go through users/{userId}/data/ subcollections.
  }
}
